services:
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: cargo-timescaledb
    environment:
      POSTGRES_DB: cargo_tracking
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: cargo-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cargo-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  emqx:
    image: emqx/emqx:5.3.2
    container_name: cargo-emqx
    environment:
      - EMQX_NAME=emqx
      - EMQX_HOST=127.0.0.1
    ports:
      - "1883:1883"
      - "8883:8883"
      - "8083:8083"
      - "8084:8084"
      - "18083:18083"
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
    healthcheck:
      test: [ "CMD", "/opt/emqx/bin/emqx", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ingestion-service:
    build: .
    container_name: cargo-ingestion-service
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      emqx:
        condition: service_healthy
    environment:

      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_READ_TIMEOUT=30s
      - SERVER_WRITE_TIMEOUT=30s
      - SERVER_SHUTDOWN_TIMEOUT=10s

      - DATABASE_HOST=timescaledb
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=cargo_tracking
      - DATABASE_SSLMODE=disable
      - DATABASE_MAX_OPEN_CONNS=25
      - DATABASE_MAX_IDLE_CONNS=5
      - DATABASE_CONN_MAX_LIFETIME=5m
      - DATABASE_CONN_MAX_IDLE_TIME=1m

      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_POOL_SIZE=10
      - REDIS_MIN_IDLE_CONNS=5
      - REDIS_MAX_RETRIES=3
      # RabbitMQ
      - RABBIT_URL=amqp://guest:guest@rabbitmq:5672/
      - RABBIT_EXCHANGE=cargo_tracking
      - RABBIT_EVENT_QUEUE=events
      - RABBIT_DEVICE_UPDATE_QUEUE=device_updates
      - RABBIT_PREFETCH_COUNT=10
      - RABBIT_DURABLE=true
      - RABBIT_CUSTOMER_TAG=ingestion-service

      - MQTT_BROKER=emqx
      - MQTT_PORT=1883
      - MQTT_CLIENT_ID=cargo-ingestion-service
      - MQTT_USERNAME=
      - MQTT_PASSWORD=
      - MQTT_QOS=1
      - MQTT_CLEAN_SESSION=true
      - MQTT_KEEP_ALIVE=60s
      - MQTT_CONNECT_TIMEOUT=10s
      - MQTT_AUTO_RECONNECT=true
      - MQTT_MAX_RECONNECT_DELAY=5m
      - MQTT_TELEMETRY_TOPIC=devices/+/telemetry
      - MQTT_HEARTBEAT_TOPIC=devices/+/heartbeat
      - MQTT_COMMAND_TOPIC=devices/+/command

      - JWT_PUBLIC_KEY_PATH=/app/resources/keys/public.pem
      - JWT_ISSUER=cargo-tracking
      - JWT_AUDIENCE=cargo-tracking-api

      - WORKER_BATCH_SIZE=100
      - WORKER_BATCH_TIMEOUT=5s
      - WORKER_EVENT_DETECTOR_WORKERS=3
      - WORKER_CACHE_SYNC_INTERVAL=1m
      # Rate Limit
      - RATE_LIMIT_REQUEST_PER_SECOND=100
      - RATE_LIMIT_BURST=200
    ports:
      - "8080:8080"
    volumes:
      - ./resources/keys:/app/resources/keys:ro
    restart: unless-stopped

volumes:
  timescale-data:
  redis-data:
  rabbitmq-data:
  emqx-data:
  emqx-log:

networks:
  default:
    name: cargo-network